<html>
	<head>
		<title>Tunnel Vision</title>
		<script>
glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:"undefined"!=typeof WebGLFloatArray?WebGLFloatArray:Array;
var vec3={create:function(a){var b=new glMatrixArrayType(3);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2]);return b},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b},add:function(a,b,c){if(!c||a==c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c},subtract:function(a,b,c){if(!c||a==c)return a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a;c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c},negate:function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b},scale:function(a,
b,c){if(!c||a==c)return a[0]*=b,a[1]*=b,a[2]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c},normalize:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=Math.sqrt(c*c+d*d+e*e);if(g){if(1==g)return b[0]=c,b[1]=d,b[2]=e,b}else return b[0]=0,b[1]=0,b[2]=0,b;g=1/g;b[0]=c*g;b[1]=d*g;b[2]=e*g;return b},cross:function(a,b,c){c||(c=a);var d=a[0],e=a[1];a=a[2];var g=b[0],f=b[1];b=b[2];c[0]=e*b-a*f;c[1]=a*g-d*b;c[2]=d*f-e*g;return c},length:function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*
a)},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},direction:function(a,b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1];a=a[2]-b[2];b=Math.sqrt(d*d+e*e+a*a);if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/b;c[0]=d*b;c[1]=e*b;c[2]=a*b;return c},lerp:function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return d},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"}},mat3={create:function(a){var b=new glMatrixArrayType(9);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=
a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9]);return b},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return b},identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a},transpose:function(a,b){if(!b||a==b){var c=a[1],d=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=d;a[7]=e;return a}b[0]=a[0];b[1]=a[3];b[2]=a[6];b[3]=a[1];b[4]=a[4];b[5]=a[7];b[6]=a[2];b[7]=a[5];b[8]=a[8];return b},
toMat4:function(a,b){b||(b=mat4.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=0;b[4]=a[3];b[5]=a[4];b[6]=a[5];b[7]=0;b[8]=a[6];b[9]=a[7];b[10]=a[8];b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"}},mat4={create:function(a){var b=new glMatrixArrayType(16);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=
a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]);return b},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b},identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},transpose:function(a,b){if(!b||a==b){var c=a[1],d=a[2],e=a[3],g=a[6],f=a[7],h=a[11];a[1]=a[4];a[2]=
a[8];a[3]=a[12];a[4]=c;a[6]=a[9];a[7]=a[13];a[8]=d;a[9]=g;a[11]=a[14];a[12]=e;a[13]=f;a[14]=h;return a}b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b},determinant:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],g=a[4],f=a[5],h=a[6],j=a[7],k=a[8],m=a[9],l=a[10],r=a[11],n=a[12],q=a[13],s=a[14];a=a[15];return n*m*h*e-k*q*h*e-n*f*l*e+g*q*l*e+k*f*s*e-g*m*s*e-n*m*d*j+k*q*d*j+
n*c*l*j-b*q*l*j-k*c*s*j+b*m*s*j+n*f*d*r-g*q*d*r-n*c*h*r+b*q*h*r+g*c*s*r-b*f*s*r-k*f*d*a+g*m*d*a+k*c*h*a-b*m*h*a-g*c*l*a+b*f*l*a},inverse:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=a[4],h=a[5],j=a[6],k=a[7],m=a[8],l=a[9],r=a[10],n=a[11],q=a[12],s=a[13],u=a[14],v=a[15],D=c*h-d*f,E=c*j-e*f,w=c*k-g*f,x=d*j-e*h,y=d*k-g*h,z=e*k-g*j,A=m*s-l*q,B=m*u-r*q,C=m*v-n*q,F=l*u-r*s,G=l*v-n*s,H=r*v-n*u,t=1/(D*H-E*G+w*F+x*C-y*B+z*A);b[0]=(h*H-j*G+k*F)*t;b[1]=(-d*H+e*G-g*F)*t;b[2]=(s*z-u*y+v*x)*t;b[3]=
(-l*z+r*y-n*x)*t;b[4]=(-f*H+j*C-k*B)*t;b[5]=(c*H-e*C+g*B)*t;b[6]=(-q*z+u*w-v*E)*t;b[7]=(m*z-r*w+n*E)*t;b[8]=(f*G-h*C+k*A)*t;b[9]=(-c*G+d*C-g*A)*t;b[10]=(q*y-s*w+v*D)*t;b[11]=(-m*y+l*w-n*D)*t;b[12]=(-f*F+h*B-j*A)*t;b[13]=(c*F-d*B+e*A)*t;b[14]=(-q*x+s*E-u*D)*t;b[15]=(m*x-l*E+r*D)*t;return b},toRotationMat:function(a,b){b||(b=mat4.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},
toMat3:function(a,b){b||(b=mat3.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[4];b[4]=a[5];b[5]=a[6];b[6]=a[8];b[7]=a[9];b[8]=a[10];return b},toInverseMat3:function(a,b){var c=a[0],d=a[1],e=a[2],g=a[4],f=a[5],h=a[6],j=a[8],k=a[9],m=a[10],l=m*f-h*k,r=-m*g+h*j,n=k*g-f*j,q=c*l+d*r+e*n;if(!q)return null;q=1/q;b||(b=mat3.create());b[0]=l*q;b[1]=(-m*d+e*k)*q;b[2]=(h*d-e*f)*q;b[3]=r*q;b[4]=(m*c-e*j)*q;b[5]=(-h*c+e*g)*q;b[6]=n*q;b[7]=(-k*c+d*j)*q;b[8]=(f*c-d*g)*q;return b},multiply:function(a,b,c){c||(c=
a);var d=a[0],e=a[1],g=a[2],f=a[3],h=a[4],j=a[5],k=a[6],m=a[7],l=a[8],r=a[9],n=a[10],q=a[11],s=a[12],u=a[13],v=a[14];a=a[15];var D=b[0],E=b[1],w=b[2],x=b[3],y=b[4],z=b[5],A=b[6],B=b[7],C=b[8],F=b[9],G=b[10],H=b[11],t=b[12],I=b[13],J=b[14];b=b[15];c[0]=D*d+E*h+w*l+x*s;c[1]=D*e+E*j+w*r+x*u;c[2]=D*g+E*k+w*n+x*v;c[3]=D*f+E*m+w*q+x*a;c[4]=y*d+z*h+A*l+B*s;c[5]=y*e+z*j+A*r+B*u;c[6]=y*g+z*k+A*n+B*v;c[7]=y*f+z*m+A*q+B*a;c[8]=C*d+F*h+G*l+H*s;c[9]=C*e+F*j+G*r+H*u;c[10]=C*g+F*k+G*n+H*v;c[11]=C*f+F*m+G*q+H*a;
c[12]=t*d+I*h+J*l+b*s;c[13]=t*e+I*j+J*r+b*u;c[14]=t*g+I*k+J*n+b*v;c[15]=t*f+I*m+J*q+b*a;return c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c},multiplyVec4:function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2];b=b[3];c[0]=a[0]*d+a[4]*e+a[8]*g+a[12]*b;c[1]=a[1]*d+a[5]*e+a[9]*g+a[13]*b;c[2]=a[2]*d+a[6]*e+a[10]*g+a[14]*b;c[3]=a[3]*d+a[7]*e+a[11]*g+a[15]*b;return c},translate:function(a,
b,c){var d=b[0],e=b[1];b=b[2];if(!c||a==c)return a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a;var g=a[0],f=a[1],h=a[2],j=a[3],k=a[4],m=a[5],l=a[6],r=a[7],n=a[8],q=a[9],s=a[10],u=a[11];c[0]=g;c[1]=f;c[2]=h;c[3]=j;c[4]=k;c[5]=m;c[6]=l;c[7]=r;c[8]=n;c[9]=q;c[10]=s;c[11]=u;c[12]=g*d+k*e+n*b+a[12];c[13]=f*d+m*e+q*b+a[13];c[14]=h*d+l*e+s*b+a[14];c[15]=j*d+r*e+u*b+a[15];return c},scale:function(a,b,c){var d=b[0],e=
b[1];b=b[2];if(!c||a==c)return a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=b,a[9]*=b,a[10]*=b,a[11]*=b,a;c[0]=a[0]*d;c[1]=a[1]*d;c[2]=a[2]*d;c[3]=a[3]*d;c[4]=a[4]*e;c[5]=a[5]*e;c[6]=a[6]*e;c[7]=a[7]*e;c[8]=a[8]*b;c[9]=a[9]*b;c[10]=a[10]*b;c[11]=a[11]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c},rotate:function(a,b,c,d){var e=c[0],g=c[1];c=c[2];var f=Math.sqrt(e*e+g*g+c*c);if(!f)return null;1!=f&&(f=1/f,e*=f,g*=f,c*=f);var h=Math.sin(b),j=Math.cos(b),k=1-j;
b=a[0];var f=a[1],m=a[2],l=a[3],r=a[4],n=a[5],q=a[6],s=a[7],u=a[8],v=a[9],D=a[10],E=a[11],w=e*e*k+j,x=g*e*k+c*h,y=c*e*k-g*h,z=e*g*k-c*h,A=g*g*k+j,B=c*g*k+e*h,C=e*c*k+g*h,e=g*c*k-e*h,g=c*c*k+j;d?a!=d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a;d[0]=b*w+r*x+u*y;d[1]=f*w+n*x+v*y;d[2]=m*w+q*x+D*y;d[3]=l*w+s*x+E*y;d[4]=b*z+r*A+u*B;d[5]=f*z+n*A+v*B;d[6]=m*z+q*A+D*B;d[7]=l*z+s*A+E*B;d[8]=b*C+r*e+u*g;d[9]=f*C+n*e+v*g;d[10]=m*C+q*e+D*g;d[11]=l*C+s*e+E*g;return d},rotateX:function(a,b,c){var d=Math.sin(b);
b=Math.cos(b);var e=a[4],g=a[5],f=a[6],h=a[7],j=a[8],k=a[9],m=a[10],l=a[11];c?a!=c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[4]=e*b+j*d;c[5]=g*b+k*d;c[6]=f*b+m*d;c[7]=h*b+l*d;c[8]=e*-d+j*b;c[9]=g*-d+k*b;c[10]=f*-d+m*b;c[11]=h*-d+l*b;return c},rotateY:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],g=a[1],f=a[2],h=a[3],j=a[8],k=a[9],m=a[10],l=a[11];c?a!=c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],
c[15]=a[15]):c=a;c[0]=e*b+j*-d;c[1]=g*b+k*-d;c[2]=f*b+m*-d;c[3]=h*b+l*-d;c[8]=e*d+j*b;c[9]=g*d+k*b;c[10]=f*d+m*b;c[11]=h*d+l*b;return c},rotateZ:function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],g=a[1],f=a[2],h=a[3],j=a[4],k=a[5],m=a[6],l=a[7];c?a!=c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+j*d;c[1]=g*b+k*d;c[2]=f*b+m*d;c[3]=h*b+l*d;c[4]=e*-d+j*b;c[5]=g*-d+k*b;c[6]=f*-d+m*b;c[7]=h*-d+l*b;return c},frustum:function(a,b,c,d,
e,g,f){f||(f=mat4.create());var h=b-a,j=d-c,k=g-e;f[0]=2*e/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2*e/j;f[6]=0;f[7]=0;f[8]=(b+a)/h;f[9]=(d+c)/j;f[10]=-(g+e)/k;f[11]=-1;f[12]=0;f[13]=0;f[14]=-(2*g*e)/k;f[15]=0;return f},perspective:function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b*=a;return mat4.frustum(-b,b,-a,a,c,d,e)},ortho:function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,j=d-c,k=g-e;f[0]=2/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/j;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/k;f[11]=0;f[12]=-(a+b)/h;f[13]=
-(d+c)/j;f[14]=-(g+e)/k;f[15]=1;return f},lookAt:function(a,b,c,d){d||(d=mat4.create());var e=a[0],g=a[1];a=a[2];var f=c[0],h=c[1],j=c[2];c=b[1];var k=b[2];if(e==b[0]&&g==c&&a==k)return mat4.identity(d);var m,l,r,n;c=e-b[0];k=g-b[1];b=a-b[2];n=1/Math.sqrt(c*c+k*k+b*b);c*=n;k*=n;b*=n;m=h*b-j*k;j=j*c-f*b;f=f*k-h*c;(n=Math.sqrt(m*m+j*j+f*f))?(n=1/n,m*=n,j*=n,f*=n):f=j=m=0;h=k*f-b*j;l=b*m-c*f;r=c*j-k*m;(n=Math.sqrt(h*h+l*l+r*r))?(n=1/n,h*=n,l*=n,r*=n):r=l=h=0;d[0]=m;d[1]=h;d[2]=c;d[3]=0;d[4]=j;d[5]=l;
d[6]=k;d[7]=0;d[8]=f;d[9]=r;d[10]=b;d[11]=0;d[12]=-(m*e+j*g+f*a);d[13]=-(h*e+l*g+r*a);d[14]=-(c*e+k*g+b*a);d[15]=1;return d},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"}};
quat4={create:function(a){var b=new glMatrixArrayType(4);a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]);return b},set:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},calculateW:function(a,b){var c=a[0],d=a[1],e=a[2];if(!b||a==b)return a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a;b[0]=c;b[1]=d;b[2]=e;b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return b},inverse:function(a,b){if(!b||a==b)return a[0]*=1,a[1]*=1,a[2]*=1,a;b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=a[3];return b},length:function(a){var b=
a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},normalize:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=Math.sqrt(c*c+d*d+e*e+g*g);if(0==f)return b[0]=0,b[1]=0,b[2]=0,b[3]=0,b;f=1/f;b[0]=c*f;b[1]=d*f;b[2]=e*f;b[3]=g*f;return b},multiply:function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2];a=a[3];var f=b[0],h=b[1],j=b[2];b=b[3];c[0]=d*b+a*f+e*j-g*h;c[1]=e*b+a*h+g*f-d*j;c[2]=g*b+a*j+d*h-e*f;c[3]=a*b-d*f-e*h-g*j;return c},multiplyVec3:function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=
b[2];b=a[0];var f=a[1],h=a[2];a=a[3];var j=a*d+f*g-h*e,k=a*e+h*d-b*g,m=a*g+b*e-f*d,d=-b*d-f*e-h*g;c[0]=j*a+d*-b+k*-h-m*-f;c[1]=k*a+d*-f+m*-b-j*-h;c[2]=m*a+d*-h+j*-f-k*-b;return c},toMat3:function(a,b){b||(b=mat3.create());var c=a[0],d=a[1],e=a[2],g=a[3],f=c+c,h=d+d,j=e+e,k=c*f,m=c*h,c=c*j,l=d*h,d=d*j,e=e*j,f=g*f,h=g*h,g=g*j;b[0]=1-(l+e);b[1]=m-g;b[2]=c+h;b[3]=m+g;b[4]=1-(k+e);b[5]=d-f;b[6]=c-h;b[7]=d+f;b[8]=1-(k+l);return b},toMat4:function(a,b){b||(b=mat4.create());var c=a[0],d=a[1],e=a[2],g=a[3],
f=c+c,h=d+d,j=e+e,k=c*f,m=c*h,c=c*j,l=d*h,d=d*j,e=e*j,f=g*f,h=g*h,g=g*j;b[0]=1-(l+e);b[1]=m-g;b[2]=c+h;b[3]=0;b[4]=m+g;b[5]=1-(k+e);b[6]=d-f;b[7]=0;b[8]=c-h;b[9]=d+f;b[10]=1-(k+l);b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},slerp:function(a,b,c,d){d||(d=a);var e=c;0>a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]&&(e=-1*c);d[0]=1-c*a[0]+e*b[0];d[1]=1-c*a[1]+e*b[1];d[2]=1-c*a[2]+e*b[2];d[3]=1-c*a[3]+e*b[3];return d},str:function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"}};
var gl,shader,canvas,context,entities=[],K_LEFT=!1,K_RIGHT=!1,K_UP=!1,K_DOWN=!1,K_SPACE=!1,K_KONAMI=!1,KONAMI_CODE=[38,38,40,40,37,39,37,39,66,65],gCamera,gTextures={},vMatrix,wMatrix=mat4.create(),pMatrix=mat4.create(),STD_SHADER,cos=Math.cos,sin=Math.sin,tan=Math.tan,abs=Math.abs,lastT,curT;function run(){initGL();document.onkeydown=onKeyDown;document.onkeyup=onKeyUp;gameInit()}function connect(){return 0}function receive(a,b){var c=a(b);entities.push(c);return c}
function receiveAll(a,b,c){if(void 0!==b){for(var d=[],e=0;e<b;e++){var g=a(c);d.push(g);entities.push(g)}return d}}function receiveNew(a,b){var c=a(b);entities.push(c);return c}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/30)}}();
function initGL(){canvas=document.getElementById("game");canvas.width=document.body.clientWidth;canvas.height=document.body.clientHeight;try{gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl")||canvas.getContext("webkit-3d")||canvas.getContext("moz-webgl"),gl.viewportWidth=canvas.width,gl.viewportHeight=canvas.height}catch(a){}gl||alert("Sorry, WebGL not supported.");try{context=document.getElementById("2D").getContext("2d")}catch(b){}context||alert("Could not bind 2D context.");
initShaders();gl.clearColor(0,0,0,1);gl.enable(gl.DEPTH_TEST);gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);mat4.perspective(55,gl.viewportWidth/gl.viewportHeight,0.3,400,pMatrix);gl.uniformMatrix4fv(STD_SHADER.pMatrix,!1,pMatrix)}function render(){gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);vMatrix=gCamera.getMatrix();gl.uniformMatrix4fv(STD_SHADER.vMatrix,!1,vMatrix);for(ent in entities)entities[ent].render&&(mat4.identity(wMatrix),entities[ent].render(wMatrix))}
function loadTexture(a){if(gTextures[a])return gTextures[a];var b=gl.createTexture();b.image=new Image;b.image.onload=function(){handleLoadedTexture(b)};b.image.src=a;return gTextures[a]=b}function setTexture(a){gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,a);gl.uniform1i(STD_SHADER.samplerUniform,0)}
function handleLoadedTexture(a){gl.bindTexture(gl.TEXTURE_2D,a);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,gl.RGB,gl.UNSIGNED_BYTE,a.image);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.bindTexture(gl.TEXTURE_2D,null)}
function StoreTexture(a,b){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);gl.bindTexture(gl.TEXTURE_2D,a);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,b);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.bindTexture(gl.TEXTURE_2D,null)}
function BufferMesh(a){if(a.buffered)return a;a.vert_buf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,a.vert_buf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(a.vertices),gl.STATIC_DRAW);a.uvs&&(a.uv_buf=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,a.uv_buf),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(a.uvs),gl.STATIC_DRAW));a.normals&&(a.norm_buf=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,a.norm_buf),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(a.normals),gl.STATIC_DRAW));a.buffered=
!0;return a}function DrawMesh(a,b,c){void 0===c&&(c=STD_SHADER);gl.bindBuffer(gl.ARRAY_BUFFER,a.vert_buf);gl.vertexAttribPointer(c.vertPos,3,gl.FLOAT,!1,0,0);a.norm_buf&&void 0!==c.vertNorm&&(gl.bindBuffer(gl.ARRAY_BUFFER,a.norm_buf),gl.vertexAttribPointer(c.vertNorm,3,gl.FLOAT,!1,0,0));a.uv_buf&&void 0!==c.texCoord&&(gl.bindBuffer(gl.ARRAY_BUFFER,a.uv_buf),gl.vertexAttribPointer(c.texCoord,2,gl.FLOAT,!1,0,0));gl.uniformMatrix4fv(c.wMatrix,!1,b);gl.drawArrays(gl.TRIANGLES,0,3*a.count)}
function MeshTransformUVs(a,b){for(var c=0;c<a.uvs.length;c+=2){var d=a.uvs[c],e=a.uvs[c+1];a.uvs[c]=b[0]*d+b[1]*e+b[2];a.uvs[c+1]=b[3]*d+b[4]*e+b[5]}}var keysDown={},lastKeys=[0,0,0,0,0,0,0,0,0,0],K_DOWN=40,K_RIGHT=39,K_UP=38,K_LEFT=37,K_SPACE=32;function InputtingEntity(a,b){a.keyDown=function(a){return b==puid&&a in keysDown};return a}
function onKeyDown(a){a||(a=window.event);keysDown[a.keyCode]=!0;lastKeys.push(a.keyCode);lastKeys.splice(0,1);K_KONAMI=!0;for(a=0;10>a;a++)lastKeys[a]!=KONAMI_CODE[a]&&(K_KONAMI=!1)}function onKeyUp(a){a||(a=window.event);a.keyCode in keysDown&&delete keysDown[a.keyCode]}function startGame(){curT=(new Date).getTime();gameLoop()}function gameLoop(){window.requestAnimFrame(gameLoop,canvas);render();lastT=curT;curT=(new Date).getTime();var a=(curT-lastT)/1E3;1<a&&(a=1);update(a);Physics(a)}
function update(a){for(ent in entities)entities[ent].update&&entities[ent].update(a)}function removeEntity(a){var b=entities.indexOf(a);-1!=b&&entities.splice(b,1);a.destroy&&a.destroy()}function TransformMesh(a,b){a.vertices=Mat4TransformPoints(a.vertices,b);a.normals=Mat3TransformPoints(a.vertices,b);return a}
function StaticEntity(a,b){if(b){var c=a;a={uvs:c.uvs,count:c.count};a.vertices=Mat4TransformPoints(c.vertices,b);a.normals=Mat3TransformPoints(c.normals,b)}BufferMesh(a);var d=PhysicalEntity({},a,!1);d.shader=STD_SHADER;d.render=function(a){mat4.set(Mat4List(d.matrix),a);DrawMesh(d.mesh,a,d.shader)};return d}
function DynamicEntity(a,b){var c;b?(c={uvs:a.uvs,count:a.count},c.vertices=Mat4TransformPoints(a.vertices,b),c.normals=Mat3TransformPoints(a.normals,b)):c=a;BufferMesh(c);var d=PhysicalEntity({},c,!0);d.shader=STD_SHADER;d.render=function(a){mat4.set(Mat4List(d.matrix),a);DrawMesh(d.mesh,a,d.shader)};return d}
function addPoint(a,b,c,d,e,g,f){a.vertices=a.vertices.concat(b[c][d]);void 0===g||void 0===f?(a.uvs.push(c/b.length),a.uvs.push(d/b[0].length)):(a.uvs.push(g/b.length),a.uvs.push(f/b[0].length));g=b.length;f=b[0].length;var h=Vector3();if(0<c){if(0<d||e)h=VecAdd(h,VecNormalize(VecCross(VecSub(b[c-1][d],b[c][d]),VecSub(b[c][(d-1+f)%f],b[c][d]))));if(d<b[0].length-1||e)h=VecAdd(h,VecNormalize(VecCross(VecSub(b[c][(d+1+f)%f],b[c][d]),VecSub(b[c-1][d],b[c][d]))))}if(c<b.length-1){if(0<d||e)h=VecAdd(h,
VecNormalize(VecCross(VecSub(b[c][(d-1+f)%f],b[c][d]),VecSub(b[c+1][d],b[c][d]))));if(d<b[0].length-1||e)h=VecAdd(h,VecNormalize(VecCross(VecSub(b[c+1][d],b[c][d]),VecSub(b[c][(d+1)%f],b[c][d]))))}e&&(0==c?h=VecCross(VecSub(b[c+1][d],b[c][d]),VecSub(b[c+1][(d+1)%f],b[c][d])):c==g-1&&(h=VecCross(VecSub(b[c-1][d],b[c][d]),VecSub(b[c-1][(d+1)%f],b[c][d]))));a.normals=a.normals.concat(VecNormalize(h))}
function Math2Mesh(a,b,c,d){var e=[],g,f;g=(b[1]-b[0])/d;d=(c[1]-c[0])/d;var h=g<d?g:d;d=b[0];for(g=0;d<=b[1];d+=h,g++){e.push([]);var j=c[0];for(f=0;j<=c[1];j+=h,f++)e[g].push(Vector3(d,a(d,j),j))}a={};a.count=2*(g-1)*(f-1);a.vertices=[];a.normals=[];a.uvs=[];for(d=0;d<g-1;d++)for(j=0;j<f-1;j++)addPoint(a,e,d,j),addPoint(a,e,d+1,j),addPoint(a,e,d,j+1),addPoint(a,e,d,j+1),addPoint(a,e,d+1,j),addPoint(a,e,d+1,j+1);return a}
function Math2MeshSphere(a,b,c){for(var d=[],e=[],g=0;g<=b;g++){d.push([]);e.push([]);for(var f=g/b*Math.PI,h=0;h<c;h++){var j=2*h/c*Math.PI-Math.PI,k=a(j,f);e[g][h]=Vector3(cos(j)*sin(f),cos(f),sin(j)*sin(f));d[g][h]=VecScale(e[g][h],k)}}a={};a.count=2*(b-1)*c;a.vertices=[];a.normals=[];a.uvs=[];for(g=1;g<b-1;g++)for(h=0;h<c;h++)addPoint(a,d,g,h,e),addPoint(a,d,g+1,h,e),addPoint(a,d,g,(h+1)%c,e,g,h+1),addPoint(a,d,g,(h+1)%c,e,g,h+1),addPoint(a,d,g+1,h,e),addPoint(a,d,g+1,(h+1)%c,e,g+1,h+1);for(h=
0;h<c;h++)addPoint(a,d,0,0,e,0,h+1),addPoint(a,d,1,h,e),addPoint(a,d,1,(h+1)%c,e,1,h+1),addPoint(a,d,b-1,(h+1)%c,e,b-1,h+1),addPoint(a,d,b-1,h,e),addPoint(a,d,b,0,e,b,h+1);return a}
function Math2MeshCylinder(a,b,c,d){for(var e=[],g=[],f=0;f<b;f++){e.push([]);g.push([]);for(var h=0;h<c;h++){var j=a(2*h/c*Math.PI-Math.PI,f/b);g[f][h]=j;e[f][h]=j}}a={};a.count=2*(b-1)*c;d&&(a.count+=2*c);a.vertices=[];a.normals=[];a.uvs=[];for(f=0;f<b-1;f++)for(h=0;h<c;h++)addPoint(a,e,f,h,g),addPoint(a,e,f+1,h,g),addPoint(a,e,f,(h+1)%c,g,f,h+1),addPoint(a,e,f,(h+1)%c,g,f,h+1),addPoint(a,e,f+1,h,g),addPoint(a,e,f+1,(h+1)%c,g,f+1,h+1);if(d){e.push([]);g.push([]);e[b][0]=e[0][0];e[b][1]=VecScale(VecAdd(e[0][0],
e[0][c/2]),0.5);e[b][2]=e[0][c/2];e[b][3]=e[b-1][0];e[b][4]=VecScale(VecAdd(e[b-1][0],e[b-1][c/2]),0.5);e[b][5]=e[b-1][c/2];for(d=0;3>d;d++)g[b].push([0,-1,0]);for(d=0;3>d;d++)g[b].push([0,1,0]);for(h=0;h<c;h++)addPoint(a,e,b,1,g,0,h+1),addPoint(a,e,1,h,g),addPoint(a,e,1,(h+1)%c,g,1,h+1),addPoint(a,e,b-1,(h+1)%c,g,b-1,h+1),addPoint(a,e,b-1,h,g),addPoint(a,e,b,4,g,b,h+1)}return a}
function physics(a,b){a.pos[0]+=a.vel[0]*b;a.pos[1]+=a.vel[1]*b;a.pos[2]+=a.vel[2]*b;a.accl&&(a.vel[0]+=a.accl[0]*b,a.vel[1]+=a.accl[1]*b,a.vel[2]+=a.accl[2]*b);a.drag&&(a.vel[0]-=a.vel[0]*a.drag*b,a.vel[1]-=a.vel[1]*a.drag*b,a.vel[2]-=a.vel[2]*a.drag*b);void 0!==a.rotv&&(a.rot+=a.rotv*b);void 0!==a.rota&&(a.rotv+=a.rota*b)}function Camera(a){var b=mat4.create();mat4.lookAt([0,0,0],a,[0,1,0],b);return{getMatrix:function(){return b}}}
function TrackingCamera(a){var b={pos:[0,10,0],vel:[0,0,0],accl:[0,0,0],drag:3,bounds:{min:[-1,-1,-1],max:[1,1,1]}},c=[0,0,1],d=[0,0,0];b.update=function(e){a&&a.pos&&(c[0]=a.pos[0],c[1]=a.pos[1]+0.5,c[2]=a.pos[2],d=VecRotate(Vector3(0,2,-8),a.rot),d=VecScale(d,0.12),d=VecAdd(d,c));4E4<VecLengthSqr(VecSub(d,b.pos))&&(b.pos=VecCopy(d));b.accl[0]=25*(d[0]-b.pos[0]);b.accl[1]=25*(d[1]-b.pos[1]);b.accl[2]=25*(d[2]-b.pos[2]);physics(b,e)};var e=mat4.create();b.getMatrix=function(){mat4.lookAt(b.pos,c,
[0,1,0],e);return e};return b}
var STD_PIXEL_SHADER="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec3 vLighting;\nvoid main(void)\n{\ngl_FragColor = ((dot(vLighting, vLighting) * 0.5) + (dot(vLighting, vec3(-0.4, 0.4, -0.4)) * 0.7)) * vColor;\ngl_FragColor = vec4(vec3(gl_FragColor), 1.0);\n}\n",STD_VERT_SHADER="attribute vec3 aVertPos;\nattribute vec3 aVertNorm;\nattribute vec4 aVertColor;\nuniform mat4 uWMatrix;\nuniform mat4 uVMatrix;\nuniform mat4 uPMatrix;\nuniform vec4 uColor;\nvarying vec4 vColor;\nvarying vec3 vLighting;\nvoid main(void) {\ngl_Position = uPMatrix * uVMatrix * uWMatrix * vec4(aVertPos, 1.0);\nvLighting = normalize(aVertPos);\nvColor = uColor;\n}\n",TEX_PIXEL_SHADER=
"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D uTexture;\nvarying vec2 vTexCoord;\nvoid main(void)\n{\ngl_FragColor = texture2D(uTexture, vTexCoord);\n}\n",TEX_VERT_SHADER="attribute vec3 aVertPos;\nattribute vec2 aTexCoord;\nuniform mat4 uWMatrix;\nuniform mat4 uVMatrix;\nuniform mat4 uPMatrix;\nvarying vec2 vTexCoord;\nvoid main(void) {\ngl_Position = uPMatrix * uVMatrix * uWMatrix * vec4(aVertPos, 1.0);\nvTexCoord = aTexCoord;\n}\n";
function StandardShader(){var a=gl.createShader(gl.FRAGMENT_SHADER),b=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(a,STD_PIXEL_SHADER);gl.compileShader(a);if(gl.getShaderParameter(a,gl.COMPILE_STATUS))if(gl.shaderSource(b,STD_VERT_SHADER),gl.compileShader(b),gl.getShaderParameter(b,gl.COMPILE_STATUS)){var c=gl.createProgram();gl.attachShader(c,a);gl.attachShader(c,b);gl.linkProgram(c);if(gl.getProgramParameter(c,gl.LINK_STATUS))return gl.useProgram(c),c.vertPos=gl.getAttribLocation(c,"aVertPos"),
gl.enableVertexAttribArray(c.vertPos),c.wMatrix=gl.getUniformLocation(c,"uWMatrix"),c.vMatrix=gl.getUniformLocation(c,"uVMatrix"),c.pMatrix=gl.getUniformLocation(c,"uPMatrix"),c.color=gl.getUniformLocation(c,"uColor"),c.setColor=function(a,b,g,f){void 0!==a[0]&&(b=a[1],g=a[2],void 0!==a[3]&&(f=a[3]),a=a[0]);void 0===f&&(f=1);gl.uniform4f(c.color,a,b,g,f)},c.setColor([1,1,1]),c.enable=function(){gl.enableVertexAttribArray(c.vertPos);gl.useProgram(c)},c.disable=function(){gl.disableVertexAttribArray(c.vertPos)},
c.disable(),c;alert("Error: Could not initialize standard shader.")}else alert(gl.getShaderInfoLog(b));else alert(gl.getShaderInfoLog(a))}
function TextureShader(){var a=gl.createShader(gl.FRAGMENT_SHADER),b=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(a,TEX_PIXEL_SHADER);gl.compileShader(a);if(gl.getShaderParameter(a,gl.COMPILE_STATUS))if(gl.shaderSource(b,TEX_VERT_SHADER),gl.compileShader(b),gl.getShaderParameter(b,gl.COMPILE_STATUS)){var c=gl.createProgram();gl.attachShader(c,a);gl.attachShader(c,b);gl.linkProgram(c);if(gl.getProgramParameter(c,gl.LINK_STATUS))return gl.useProgram(c),c.vertPos=gl.getAttribLocation(c,"aVertPos"),
gl.enableVertexAttribArray(c.vertPos),c.texCoord=gl.getAttribLocation(c,"aTexCoord"),gl.enableVertexAttribArray(c.texCoord),c.wMatrix=gl.getUniformLocation(c,"uWMatrix"),c.vMatrix=gl.getUniformLocation(c,"uVMatrix"),c.pMatrix=gl.getUniformLocation(c,"uPMatrix"),c.enable=function(){gl.enableVertexAttribArray(c.vertPos);gl.enableVertexAttribArray(c.texCoord);gl.useProgram(c)},c.disable=function(){gl.disableVertexAttribArray(c.vertPos);gl.disableVertexAttribArray(c.texCoord)},c.disable(),c;alert("Error: Could not initialize texture shader.")}else alert(gl.getShaderInfoLog(b));
else alert(gl.getShaderInfoLog(a))}function initShaders(){TEX_SHADER=TextureShader();STD_SHADER=StandardShader();STD_SHADER.enable()}var physObjects=[],staticTree;function MAX(a,b){return a>b?a:b}function MIN(a,b){return a<b?a:b}function Vector3(a,b,c){return void 0===a?[0,0,0]:[a,b,c]}var VEC_RIGHT=Vector3(1,0,0),VEC_UP=Vector3(0,1,0),VEC_FORWARD=Vector3(0,0,1);function VecCopy(a){return[a[0],a[1],a[2]]}function VecAdd(a,b,c){return[a[0]+b[0]+c[0],a[1]+b[1]+c[1],a[2]+b[2]+c[2]]}
function VecAdd(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]}function VecSub(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]}function VecScale(a,b){return[a[0]*b,a[1]*b,a[2]*b]}function VecNormalize(a){var b=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return[a[0]*b,a[1]*b,a[2]*b]}function VecLength(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])}function VecLengthSqr(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]}function VecDot(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}
function VecCross(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]}function VecMult(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2]]}function VecRotate(a,b){return Mat4TransformPoint(a,Mat4World(Vector3(),b))}function Quat(a,b,c,d){return void 0===a?{w:1,x:0,y:0,z:0}:{w:a,x:b,y:c,z:d}}function QuatNormalize(a){var b=Math.sqrt(a.w*a.w+a.x*a.x+a.y*a.y+a.z*a.z);return{w:a.w/b,x:a.x/b,y:a.y/b,z:a.z/b}}
function QuatMult(a,b){return{w:a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z,x:a.w*b.x+a.x*b.w+a.y*b.z-a.z*b.y,y:a.w*b.y-a.x*b.z+a.y*b.w+a.z*b.x,z:a.w*b.z+a.x*b.y-a.y*b.x+a.z*b.w}}function QuatXYZ(a,b,c){a=Quat(Math.cos(a/2),Math.sin(a/2),0,0);b=Quat(Math.cos(b/2),0,Math.sin(b/2),0);c=Quat(Math.cos(c/2),0,0,Math.sin(c/2));return QuatMult(QuatMult(a,b),c)}var QUAT_EPSILON=1E-8;
function QuatSlerp(a,b,c){var d,e,g,f=a.x*b.x+a.y*b.y+a.z*b.z+a.w*b.w;0>f?(f*=-1,d=-a.x,e=-a.y,g=-a.z,a=-a.w):(d=a.x,e=a.y,g=a.z,a=a.w);if(1-f>QUAT_EPSILON){var h=Math.acos(f),j=Math.sin(h),f=Math.sin((1-c)*h)/j;c=Math.sin(c*h)/j}else f=1-c;return{x:f*d+c*b.x,y:f*e+c*b.y,z:f*g+c*b.z,w:f*a+c*b.w}}function Matrix4(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]}
function Mat4List(a){return[a[0][0],a[0][1],a[0][2],a[0][3],a[1][0],a[1][1],a[1][2],a[1][3],a[2][0],a[2][1],a[2][2],a[2][3],a[3][0],a[3][1],a[3][2],a[3][3]]}function Mat4Scale(a,b,c){void 0===b&&(c=b=a);return[[a,0,0,0],[0,b,0,0],[0,0,c,0],[0,0,0,1]]}function Mat4Translate(a){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[a[0],a[1],a[2],1]]}function Mat4FromVectors(a,b,c){return[[a[0],a[1],a[2],0],[b[0],b[1],b[2],0],[foward[0],c[1],c[2],0],[0,0,0,1]]}
function Mat4World(a,b){var c=2*b.x,d=2*b.y,e=2*b.z,g=b.w*c,f=b.w*d,h=b.w*e,c=b.x*c,j=b.x*d,k=b.x*e,d=b.y*d,m=b.y*e,e=b.z*e,l=[[],[],[],[]];l[0][0]=1-(d+e);l[0][1]=j+h;l[0][2]=k-f;l[0][3]=0;l[1][0]=j-h;l[1][1]=1-(c+e);l[1][2]=m+g;l[1][3]=0;l[2][0]=k+f;l[2][1]=m-g;l[2][2]=1-(c+d);l[2][3]=0;l[3][0]=a[0];l[3][1]=a[1];l[3][2]=a[2];l[3][3]=1;return l}
function Mat4TransformPoints(a,b){for(var c=[],d=0;d<a.length;d+=3)p=Mat4TransformPoint([a[d],a[d+1],a[d+2]],b),c.push(p[0]),c.push(p[1]),c.push(p[2]);return c}function Mat4TransformPoint(a,b){return[a[0]*b[0][0]+a[1]*b[1][0]+a[2]*b[2][0]+b[3][0],a[0]*b[0][1]+a[1]*b[1][1]+a[2]*b[2][1]+b[3][1],a[0]*b[0][2]+a[1]*b[1][2]+a[2]*b[2][2]+b[3][2]]}
function Mat3TransformPoints(a,b){for(var c=[],d=0;d<a.length;d+=3)p=Mat3TransformPoint([a[d],a[d+1],a[d+2]],b),c.push(p[0]),c.push(p[1]),c.push(p[2]);return c}function Mat3TransformPoint(a,b){return[a[0]*b[0][0]+a[1]*b[1][0]+a[2]*b[2][0],a[0]*b[0][1]+a[1]*b[1][1]+a[2]*b[2][1],a[0]*b[0][2]+a[1]*b[1][2]+a[2]*b[2][2]]}function Mat4Mult(a,b){for(var c=[],d=0;4>d;d++){c.push([]);for(var e=0;4>e;e++){c[d].push(0);for(var g=0;4>g;g++)c[d][e]+=a[d][g]*b[g][e]}}return c}
function BBCopy(a){return{max:[a.max[0],a.max[1],a.max[2]],min:[a.min[0],a.min[1],a.min[2]]}}function BBJoin(a,b){return{max:[MAX(a.max[0],b.max[0]),MAX(a.max[1],b.max[1]),MAX(a.max[2],b.max[2])],min:[MIN(a.min[0],b.min[0]),MIN(a.min[1],b.min[1]),MIN(a.min[2],b.min[2])]}}function BBAddPoint(a,b){b[0]<a.min[0]&&(a.min[0]=b[0]);b[1]<a.min[1]&&(a.min[1]=b[1]);b[2]<a.min[2]&&(a.min[2]=b[2]);b[0]>a.max[0]&&(a.max[0]=b[0]);b[1]>a.max[1]&&(a.max[1]=b[1]);b[2]>a.max[2]&&(a.max[2]=b[2])}
function BBTestPoint(a,b){return b[0]<a.min[0]||b[1]<a.min[1]||b[2]<a.min[2]||b[0]>a.max[0]||b[1]>a.max[1]||b[2]>a.max[2]?!1:!0}function BBTestBB(a,b){return a.min[0]>b.max[0]||a.min[1]>b.max[1]||a.min[2]>b.max[2]||a.max[0]<b.min[0]||a.max[1]<b.min[1]||a.max[2]<b.min[2]?!1:!0}
function BBTestRay(a,b,c,d,e){var g,f,h,j;0<=c[0]?(g=(a.min[0]-b[0])/c[0],f=(a.max[0]-b[0])/c[0]):(g=(a.max[0]-b[0])/c[0],f=(a.min[0]-b[0])/c[0]);0<=c[1]?(h=(a.min[1]-b[1])/c[1],j=(a.max[1]-b[1])/c[1]):(h=(a.max[1]-b[1])/c[1],j=(a.min[1]-b[1])/c[1]);if(g>j||h>f)return!1;h>g&&(g=h);j<f&&(f=j);0<=c[2]?(h=(a.min[2]-b[2])/c[2],a=(a.max[2]-b[2])/c[2]):(h=(a.max[2]-b[2])/c[2],a=(a.min[2]-b[2])/c[2]);if(g>a||h>f)return!1;h>g&&(g=h);a<f&&(f=a);return g<e&&f>d}
function BBFromMesh(a){for(var b,c=0;c<a.length;c+=3)void 0===b?b={min:[a[c],a[c+1],a[c+2]],max:[a[c],a[c+1],a[c+2]]}:BBAddPoint(b,[a[c],a[c+1],a[c+2]]);return b}function BBSize(a){return VecSub(a.max,a.min)}function BBCenter(a){return[(a.max[0]+a.min[0])/2,(a.max[1]+a.min[1])/2,(a.max[2]+a.min[2])/2]}function BBContains(a,b){return a.min[0]<b.min[0]&&a.min[1]<b.min[1]&&a.min[2]<b.min[2]&&a.max[0]>b.max[0]&&a.max[1]>b.max[1]&&a.max[2]>b.max[2]}var BBIntersect=BBTestBB;
function BBCut(a,b){var c=BBCenter(a),d=b%2,e=Math.floor(b/2)%2,g=Math.floor(b/4)%2;return{min:[d?c[0]:a.min[0],e?c[1]:a.min[1],g?c[2]:a.min[2]],max:[d?a.max[0]:c[0],e?a.max[1]:c[1],g?a.max[2]:c[2]]}}
function BBTransform(a,b){for(var c=[b[3][0],b[3][1],b[3][2]],d=[b[3][0],b[3][1],b[3][2]],e=[a.min[0],a.min[1],a.min[2]],g=[a.max[0],a.max[1],a.max[2]],f,h,j=0;3>j;j++)for(var k=0;3>k;k++)f=b[k][j]*e[k],h=b[k][j]*g[k],f<h?(c[j]+=f,d[j]+=h):(c[j]+=h,d[j]+=f);return{min:[c[0],c[1],c[2]],max:[d[0],d[1],d[2]]}}function Prune(a,b){for(var c=[],d,e=0;e<a.length;e+=9){d=[];for(var g=0;9>g;g++)d.push(a[e+g]);g=BBFromMesh(d);BBTestBB(b,g)&&(c=c.concat(d))}return c}
function Octree(a,b){if(20>a.length/9)return{getVertices:function(){return a}};for(var c=[],d=0;8>d;d++){var e=BBCut(b,d);c[d]=Octree(Prune(a,e),e);c[d].bb=e}return{getVertices:function(d){if(BBContains(d,b))return a;for(var e=[],h=0;8>h;h++)BBTestBB(c[h].bb,d)&&(e=e.concat(c[h].getVertices(d)));return e}}}
function PhysicalEntity(a,b,c){a.mass=5;a.force=Vector3();a.pos=Vector3();a.vel=Vector3();a.acl=Vector3();a.friction=5;a.dynamic=c;a.torque=Vector3();a.rot=Quat();a.rotVel=Quat();a.rotAcl=Quat();a.matrix=Mat4World(a.pos,a.rot);b&&(a.mesh=b,a.bb=BBFromMesh(b.vertices),a.aabb=BBTransform(a.bb,a.matrix),c?(a.radius=VecDot(BBSize(a.bb),Vector3(1/6,1/6,1/6)),a.center=BBCenter(a.bb)):a.tree=Octree(b.vertices,a.bb));var d=a.destroy;a.destroy=function(){var b=physObjects.indexOf(a);-1!=b&&physObjects.splice(b,
1);d&&d()};physObjects.push(a);return a}
function Physics(a){var b=[],c;for(c in physObjects){var d=physObjects[c];d.old_pos=d.pos;d.pos=VecAdd(d.pos,VecScale(d.vel,a));d.vel=VecAdd(d.vel,VecScale(d.acl,a));d.acl=VecAdd(VecScale(d.force,1/d.mass),VecScale(d.vel,-1*d.friction));d.rot=QuatMult(d.rot,QuatSlerp(Quat(),d.rotVel,a));var e=BBCopy(d.aabb);d.matrix=Mat4World(d.pos,d.rot);d.radius?(d.aabb={min:VecSub(BBCenter(d.bb),Vector3(d.radius,d.radius,d.radius)),max:VecAdd(BBCenter(d.bb),Vector3(d.radius,d.radius,d.radius))},d.aabb.min=VecAdd(d.aabb.min,
d.pos),d.aabb.max=VecAdd(d.aabb.max,d.pos)):d.aabb=BBTransform(d.bb,d.matrix);e=BBJoin(e,d.aabb);if(void 0!==d.mesh||void 0!==d.radius){var g=b,f;for(f in g)BBTestBB(e,g[f].aabb)&&checkCollision(d,g[f]);b.push(d)}}}
function checkCollision(a,b){var c;void 0!==a.radius?void 0!==b.radius?c=sphereSphereCollision:void 0!==b.mesh&&(c=sphereGeometryCollision):void 0!==a.mesh&&(void 0!==b.radius?c=geometrySphereCollision:void 0!==b.mesh&&(c=geometryGeometryCollision));c(a,b)&&(a.collision&&a.collision(b),b.collision&&b.collision(a))}
function sphereSphereCollision(a,b){var c=VecSub(a.pos,b.pos),d=VecLengthSqr(c),e=a.radius+b.radius;return d<e*e?(d=Math.sqrt(d),a.pos=VecAdd(b.pos,VecScale(c,(d+(e-d)*b.mass/(a.mass+b.mass))/d)),b.pos=VecAdd(a.pos,VecScale(c,-e/d)),!0):!1}function geometryGeometryCollision(){return!1}function geometrySphereCollision(a,b){return sphereGeometryCollision(b,a)}
function sphereGeometryCollision(a,b){for(var c=VecAdd(a.pos,BBCenter(a.bb)),d=VecAdd(a.old_pos,BBCenter(a.bb)),e=!1,g=b.tree.getVertices({min:VecSub(a.aabb.min,b.pos),max:VecSub(a.aabb.max,b.pos)}),f=0;f<g.length;f+=9){var h=[[g[f],g[f+1],g[f+2]],[g[f+3],g[f+4],g[f+5]],[g[f+6],g[f+7],g[f+8]]];h[0]=VecAdd(b.pos,h[0]);h[1]=VecAdd(b.pos,h[1]);h[2]=VecAdd(b.pos,h[2]);var j=VecNormalize(VecCross(VecSub(h[1],h[0]),VecSub(h[2],h[0]))),k=-VecDot(h[1],j),m=SignedDistToPlane(d,j,k),k=SignedDistToPlane(c,j,
k);if(Math.abs(k)<a.radius||0>k*m){var l=VecAdd(c,VecScale(j,-k));0>k*m&&(l=VecSub(c,d),l=VecAdd(d,VecScale(l,m/(m-k))));m=0>m?-1:1;if(PointIsInTriangle(l,h))c=VecAdd(l,VecScale(j,m*a.radius)),a.vel=VecSub(a.vel,VecScale(j,VecDot(a.vel,j))),e=!0;else for(j=0;3>j;j++)l=ClosestPointOnLine(l,h[j],h[(j+1)%3]),m=VecSub(c,l),k=VecLength(m),k<a.radius&&(m=VecScale(m,a.radius/k),c=VecAdd(l,m),e=!0)}}e&&(a.pos=VecSub(c,BBCenter(a.bb)));return e}function SignedDistToPlane(a,b,c){return VecDot(a,b)+c}
function PointIsInTriangle(a,b){var c=VecSub(b[2],b[0]),d=VecSub(b[1],b[0]),e=VecSub(a,b[0]),g=VecDot(c,c),f=VecDot(c,d),c=VecDot(c,e),h=VecDot(d,d),d=VecDot(d,e),e=1/(g*h-f*f),h=(h*c-f*d)*e,g=(g*d-f*c)*e;return 0<=h&&0<=g&&1>h+g}function ClosestPointOnLine(a,b,c){var d=VecSub(a,b);a=VecSub(c,b);var e=VecLength(a),d=VecDot(a,d)/e;return 0>d?b:d>e?c:VecAdd(b,VecScale(a,d/e))}
BOX_MESH={count:12,vertices:[0,1,1,0,0,1,1,1,1,0,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1,0,1,1,0,0,1,1,0,1,1,0,1,0,0,0,1,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,1,0,0,0,0,0,1,0,1,1,0,1,0,0,1,1,1,1,0,0,1,1,1,1,1,1,1,0,0,0,1,0,0,0,1,0,1,0,0,0,1,0,0,1,0,1],uvs:[0,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,1,1,0,0,0,0,1,1,0,0,1,1,1,1,0],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,
-1,0,0,-1,0,0,-1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]};SQUARE_MESH={count:2,vertices:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0],uvs:[0,0,1,0,0,1,0,1,1,0,1,1]};function StaticMatrix(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],0,0,0,a[15]]}function MAX(a,b){return a>b?a:b}
function RainbowTunnel(){function a(a){return[Math.sin(8*a*Math.PI),80*a,Math.cos(8*a*Math.PI)]}var b={},c=context.createImageData(64,64),d=gl.createTexture();tunnelMesh=Math2MeshCylinder(function(b,c){return VecAdd([Math.cos(b),0,Math.sin(b)],a(c))},20,100);MeshTransformUVs(tunnelMesh,[15,0,0,1,0,0]);for(var e=BufferMesh(tunnelMesh),g=0;64>g;g++)for(var f=0;64>f;f++)c.data[4*(f+64*g)+0]=128*Math.sin(f/5+Math.PI/1.5)+127,c.data[4*(f+64*g)+1]=128*Math.sin(f/5)+127,c.data[4*(f+64*g)+2]=128*Math.sin(f/
5-Math.PI/1.5)+127,c.data[4*(f+64*g)+3]=255;StoreTexture(d,c);var h=6;b.update=function(a){h-=a};b.render=function(b){b=h/10;1>h&&(h+=5);b=VecSub([0,0,0],a(b));var c=QuatXYZ(Math.PI/2,0,0);b=VecRotate(b,c);b=Mat4World(b,c);TEX_SHADER.enable();gl.uniformMatrix4fv(TEX_SHADER.pMatrix,!1,pMatrix);gl.uniformMatrix4fv(TEX_SHADER.vMatrix,!1,StaticMatrix(vMatrix));gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,d);gl.uniform1i(TEX_SHADER.samplerUniform,0);DrawMesh(e,Mat4List(b),TEX_SHADER);gl.uniformMatrix4fv(TEX_SHADER.vMatrix,
!1,vMatrix);TEX_SHADER.disable();STD_SHADER.enable()};return b}function gameInit(){puid=connect();tunnel=receive(RainbowTunnel);gCamera=receiveNew(Camera,[0,0,1]);startGame()};
		</script>
		<style>
			#game {
				position: absolute;
				top: 0;
				left: 0;
				border: none;
			}
		</style>
	</head>
	<body onload="run();">
		<canvas id="game" width="100%" height="100%">
		</canvas>
		<canvas id="2D" style="visibility: hidden;">
	</body>
</html>
